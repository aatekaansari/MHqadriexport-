<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MH Qadri Export Rugs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
      padding-top: 140px;
      padding-bottom: 60px;
    }
    header, footer {
      background-color: #2196F3;
      color: white;
      text-align: center;
      width: 100%;
      position: fixed;
      left: 0;
      z-index: 100;
    }
    header {
      top: 0;
      padding: 15px 0;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
    }
    footer {
      bottom: 0;
      padding: 10px 0;
      font-size: 14px;
    }
    #nav-section {
      position: fixed;
      top: 70px;
      width: 100%;
      background-color: #1976D2;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 5px;
      padding: 5px 0;
      z-index: 99;
    }
    #nav-section button.fixed-btn {
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      color: white;
    }
    #company-fixed-btn {
      background-color: #4CAF50;
    }
    #contractor-fixed-btn {
      background-color: #FF9800;
    }
    #profile-buttons-container {
      width: 100%;
      background-color: #424242;
      padding: 5px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      align-items: center;
    }
    #company-profile-buttons,
    #contractor-buttons-container {
      width: 100%;
      display: flex;
      justify-content: center;
      gap: 5px;
      margin-top: 5px;
    }
    #company-profile-buttons button {
      background-color: #9C27B0;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      color: white;
      cursor: pointer;
    }
    #company-profile-buttons button:hover {
      background-color: #7B1FA2;
    }
    #contractor-buttons-container button {
      background-color: #FF5722;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 12px;
      color: white;
      cursor: pointer;
    }
    #contractor-buttons-container button:hover {
      background-color: #E64A19;
    }
    main {
      padding: 20px;
      max-width: 100%;
      overflow-x: hidden;
      margin-top: 140px;
    }
    section {
      display: none;
      margin-bottom: 20px;
      background-color: #BBDEFB;
      padding: 20px;
      border-radius: 5px;
    }
    #order-output-section,
    #order-entry-section,
    #company-profile-section,
    #contractor-profile-section,
    #pay-amount-section,
    #payment-detail-section {
      display: none;
    }
    #additional-fields {
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      min-width: 600px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 16px;
      text-align: left;
      font-size: 16px;
    }
    th {
      background-color: #2196F3;
      color: white;
    }
    .form-group {
      margin-bottom: 15px;
    }
    input[type="text"],
    input[type="date"],
    input[type="number"],
    select {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 16px;
    }
    input[name="date"] {
      border-color: #2196F3;
    }
    button {
      background-color: #2196F3;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover {
      background-color: #1976D2;
    }
    .vertical-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .profile-info {
      display: flex;
      gap: 20px;
      justify-content: center;
      font-size: 16px;
      margin-top: 10px;
    }
    .profile-info span {
      font-weight: bold;
    }
    .orders-container {
      margin-bottom: 40px;
      padding: 10px;
      border-radius: 5px;
    }
    #company-orders-container {
      background-color: #E3F2FD;
    }
    #contractor-orders-container {
      background-color: #E8F5E9;
    }
    #company-order-header,
    #contractor-order-header {
      text-align: center;
      margin-bottom: 10px;
    }
    #company-order-header h2,
    #contractor-order-header h2 {
      margin: 0;
      font-size: 22px;
    }
    #contractor-order-header h3 {
      margin: 5px 0;
      font-size: 18px;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .btn-group.no-print button {
      padding: 6px 12px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-entry-btn {
      background-color: #4CAF50;
      color: white;
    }
    .add-entry-btn:hover {
      background-color: #43A047;
    }
    .add-return-btn {
      background-color: #F44336;
      color: white;
    }
    .add-return-btn:hover {
      background-color: #D32F2F;
    }
    .pay-amount-btn {
      background-color: #2196F3;
      color: white;
    }
    .pay-amount-btn:hover {
      background-color: #1976D2;
    }
    .view-payment-details-btn {
      background-color: #9C27B0;
      color: white;
    }
    .view-payment-details-btn:hover {
      background-color: #7B1FA2;
    }
    .pdf-download-btn {
      background-color: #607D8B;
      color: white;
    }
    .pdf-download-btn:hover {
      background-color: #455A64;
    }
    @media print {
      .no-print {
        display: none !important;
      }
    }
    .table-container {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    #company-order-table tbody tr:hover,
    #contractor-order-table tbody tr:hover {
      transform: translateY(-5px);
      transition: transform 0.2s ease;
    }
    @media (max-width: 600px) {
      th, td {
        padding: 8px;
        font-size: 14px;
      }
      #nav-section {
        flex-direction: column;
        align-items: center;
      }
      #nav-section button.fixed-btn {
        width: 45%;
        margin: 2px;
        font-size: 12px;
      }
      main {
        padding: 10px;
      }
      header h1 {
        font-size: 24px;
      }
      section {
        padding: 15px;
      }
      .profile-info {
        font-size: 14px;
      }
      #payment-detail-section {
        padding: 10px;
      }
      #payment-detail-section h2 {
        font-size: 20px;
      }
      #payment-detail-section h3 {
        font-size: 16px; /* Reduced font size for h3 */
        text-align: left; /* Align to left */
      }
      #payment-detail-section p {
        font-size: 14px;
      }
      #payment-history-table {
        min-width: 100%;
        font-size: 12px;
      }
      #payment-history-table th, #payment-history-table td {
        padding: 6px;
        font-size: 12px;
      }
      #pay-amount-section {
        padding: 10px;
      }
      #pay-amount-section h2 {
        font-size: 18px;
      }
      #pay-amount-section .form-group {
        margin-bottom: 10px;
      }
      #pay-amount-section input, #pay-amount-section select {
        font-size: 14px;
      }
      #pay-amount-section button {
        font-size: 14px;
        padding: 8px 16px;
      }
    }
    .hidden {
      display: none;
    }
    .stock-issue-container {
      display: flex;
      flex-direction: row;
      justify-content: flex-start;
      gap: 10px;
      margin-top: 20px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      white-space: nowrap;
    }
    #company-received-table, #company-deliver-table, #company-balance-table,
    #contractor-received-table, #contractor-deliver-table, #contractor-balance-table {
      width: auto;
      min-width: 200px;
      font-size: 10px;
      border-collapse: collapse;
    }
    #company-received-table th, #company-received-table td,
    #company-deliver-table th, #company-deliver-table td,
    #company-balance-table th, #company-balance-table td,
    #contractor-received-table th, #contractor-received-table td,
    #contractor-deliver-table th, #contractor-deliver-table td,
    #contractor-balance-table th, #contractor-balance-table td {
      padding: 4px;
      border: 1px solid #ddd;
      white-space: nowrap;
    }
    #company-received-table th, #company-deliver-table th, #company-balance-table th,
    #contractor-received-table th, #contractor-deliver-table th, #contractor-balance-table th {
      background-color: #2196F3;
      color: white;
    }
    #company-received-table h4, #company-deliver-table h4, #company-balance-table h4,
    #contractor-received-table h4, #contractor-deliver-table h4, #contractor-balance-table h4 {
      font-size: 12px;
      margin: 0 0 6px 0;
      text-align: center;
      white-space: nowrap;
    }
    .address-details {
      font-size: 10px;
      text-align: center;
      margin-top: 10px;
    }
    #payment-detail-section h2 {
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }
    #payment-detail-section h3 {
      text-align: left; /* Align to left */
      font-size: 16px; /* Reduced font size */
      margin-bottom: 15px;
    }
    #order-summary, #payment-summary, #payment-history {
      text-align: left;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>MH Qadri Export Rugs</h1>
  </header>
  
  <div id="nav-section">
    <button id="company-fixed-btn" class="fixed-btn" onclick="showCompanyProfileSection()">Company Profile</button>
    <button id="contractor-fixed-btn" class="fixed-btn" onclick="showContractorProfileSection()">Contractor Profile</button>
  </div>
  
  <div id="profile-buttons-container">
    <div id="company-profile-buttons"></div>
    <div id="contractor-buttons-container"></div>
  </div>
  
  <main>
    <section id="company-profile-section">
      <h2>Company Profile</h2>
      <form id="company-profile-form" class="vertical-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="company-name-input" required>
        </div>
        <div class="form-group">
          <label>Mobile</label>
          <input type="text" id="company-mobile-input" required>
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="company-address-input" required>
        </div>
        <div class="form-group">
          <button type="button" onclick="saveCompanyProfile()">Save Company Profile</button>
          <button type="button" onclick="hideAllSections()">Cancel</button>
        </div>
      </form>
    </section>
    
    <section id="contractor-profile-section">
      <h2>Contractor Profile</h2>
      <form id="contractor-profile-form" class="vertical-form">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="contractor-name-input" required>
        </div>
        <div class="form-group">
          <label>Mobile</label>
          <input type="text" id="contractor-mobile-input" required>
        </div>
        <div class="form-group">
          <label>Address</label>
          <input type="text" id="contractor-address-input" required>
        </div>
        <div class="form-group">
          <button type="button" onclick="saveContractorProfile()">Save Contractor Profile</button>
          <button type="button" onclick="hideAllSections()">Cancel</button>
        </div>
      </form>
    </section>
    
    <section id="order-entry-section">
      <h2>carpet Entry (<span id="current-order-type-label"></span> Order)</h2>
      <form id="order-entry-form" class="vertical-form">
        <input type="hidden" id="is-return-input" name="isReturn" value="false">
        <div class="form-group" id="company-select-group" style="display: none;">
          <label id="company-select-label">Select Company</label>
          <select name="company-select"></select>
        </div>
        <div class="form-group">
          <label id="date-label">Date*</label>
          <input type="date" name="date" required>
        </div>
        <div class="form-group">
          <label id="size-label">Size (e.g., 9×12)</label>
          <input type="text" name="size">
        </div>
        <div class="form-group">
          <label id="peace-label">Peace</label>
          <input type="number" name="peace" step="any">
        </div>
        <div class="form-group">
          <label id="kati-label">Kati</label>
          <input type="number" name="kati" step="any">
        </div>
        <div class="form-group" id="tana-group">
          <label id="tana-label">Tana</label>
          <input type="number" name="tana" step="any">
        </div>
        <div class="form-group">
          <label id="rate-label">Rate</label>
          <input type="number" name="rate" step="any">
        </div>
        <div class="form-group" id="receive-amount-group" style="display: none;">
          <label>Receive Amount</label>
          <input type="number" name="receive-amount" step="any">
        </div>
        <div id="additional-fields"></div>
        <div class="form-group">
          <button type="submit">Submit Order</button>
          <button type="button" onclick="cancelToOrders()">Cancel</button>
        </div>
      </form>
    </section>
    
    <section id="order-output-section">
      <div id="company-orders-container" class="orders-container">
        <div id="company-order-header">
          <h2>MH Qadri Export Rugs</h2>
          <div class="profile-info" id="company-profile-info">
            <span>Name: <span id="company-output-name">N/A</span></span>
            <span>Mobile: <span id="company-output-mobile">N/A</span></span>
            <span>Address: <span id="company-output-address">N/A</span></span>
          </div>
          <h3>Company Orders</h3>
          <div class="btn-group no-print">
            <button class="add-entry-btn" onclick="showAddOrderSection('company', false)">Add Entry</button>
            <button class="add-return-btn" onclick="showAddOrderSection('company', true)">Carpet Bajar</button>
            <button class="pay-amount-btn" onclick="showPayAmountSection('company')">Pay Amount</button>
            <button class="view-payment-details-btn" onclick="showPaymentDetailSection('company')">View Payment Details</button>
            <button class="pdf-download-btn" onclick="downloadPDF('company')">Download PDF</button>
          </div>
        </div>
        <div class="table-container">
          <table id="company-order-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="stock-issue-container">
          <div>
            <h4>Received Order</h4>
            <table id="company-received-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="company-received-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="company-received-peace">0</td></tr>
                <tr><td>Total Material</td><td id="company-received-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="company-received-finalgaj">0.00</td></tr>
                <tr><td>Binai Amount</td><td id="company-received-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
          <div>
            <h4>Order Deliver</h4>
            <table id="company-deliver-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="company-deliver-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="company-deliver-peace">0</td></tr>
                <tr><td>Carpet Wait</td><td id="company-deliver-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="company-deliver-finalgaj">0.00</td></tr>
                <tr><td>Remaining Binai Amount</td><td id="company-deliver-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
          <div>
            <h4>Balance Order</h4>
            <table id="company-balance-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="company-balance-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="company-balance-peace">0</td></tr>
                <tr><td>Total Material</td><td id="company-balance-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="company-balance-finalgaj">0.00</td></tr>
                <tr><td>Binai Amount</td><td id="company-balance-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="address-details">
          Adress Chhota Mirzapur Mirzapur Uttar Pradesh pin code 231001 Mobile 998445058 Proprietor mohd Hasan ansari
        </div>
      </div>
      
      <div id="contractor-orders-container" class="orders-container">
        <div id="contractor-order-header">
          <h2 id="contractor-title">MH Qadri Export Rugs</h2>
          <h3 id="contractor-subtitle">Mirzapur</h3>
          <div class="profile-info" id="contractor-profile-info">
            <span>Name: <span id="contractor-output-name">N/A</span></span>
            <span>Mobile: <span id="contractor-output-mobile">N/A</span></span>
            <span>Address: <span id="contractor-output-address">N/A</span></span>
          </div>
          <h3>Contractor Orders</h3>
          <div class="btn-group no-print">
            <button class="add-entry-btn" onclick="showAddOrderSection('contractor', false)">Add Entry</button>
            <button class="add-return-btn" onclick="showAddOrderSection('contractor', true)">Carpet Bajar</button>
            <button class="pay-amount-btn" onclick="showPayAmountSection('contractor')">Pay Amount</button>
            <button class="view-payment-details-btn" onclick="showPaymentDetailSection('contractor')">View Payment Details</button>
            <button class="pdf-download-btn" onclick="downloadPDF('contractor')">Download PDF</button>
          </div>
        </div>
        <div class="table-container">
          <table id="contractor-order-table">
            <thead></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="stock-issue-container">
          <div>
            <h4>Received Order</h4>
            <table id="contractor-received-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="contractor-received-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="contractor-received-peace">0</td></tr>
                <tr><td>Total Material</td><td id="contractor-received-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="contractor-received-finalgaj">0.00</td></tr>
                <tr><td>Binai Amount</td><td id="contractor-received-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
          <div>
            <h4>Order Deliver</h4>
            <table id="contractor-deliver-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="contractor-deliver-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="contractor-deliver-peace">0</td></tr>
                <tr><td>Carpet Wait</td><td id="contractor-deliver-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="contractor-deliver-finalgaj">0.00</td></tr>
                <tr><td>Remaining Binai Amount</td><td id="contractor-deliver-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
          <div>
            <h4>Balance Order</h4>
            <table id="contractor-balance-table">
              <thead>
                <tr><th>Size</th><th>Peace</th></tr>
              </thead>
              <tbody id="contractor-balance-list"></tbody>
              <tfoot>
                <tr><td>Total Peace</td><td id="contractor-balance-peace">0</td></tr>
                <tr><td>Total Material</td><td id="contractor-balance-material">0</td></tr>
                <tr><td>Final Gaj</td><td id="contractor-balance-finalgaj">0.00</td></tr>
                <tr><td>Binai Amount</td><td id="contractor-balance-binai">0</td></tr>
              </tfoot>
            </table>
          </div>
        </div>
        <div class="address-details">
          Adress Chhota Mirzapur Mirzapur Uttar Pradesh pin code 231001 Mobile 998445058 Proprietor mohd Hasan ansari
        </div>
      </div>
    </section>

    <section id="pay-amount-section">
      <h2>Pay Amount to <span id="pay-to-name"></span></h2>
      <form id="pay-amount-form" class="vertical-form">
        <div class="form-group">
          <label>Remaining Binai Amount</label>
          <input type="text" id="remaining-binai-display" readonly>
        </div>
        <div class="form-group">
          <label>Date*</label>
          <input type="date" name="date" required>
        </div>
        <div class="form-group">
          <label>Amount*</label>
          <input type="number" name="amount" step="any" required>
        </div>
        <div class="form-group">
          <label>Payment Mode*</label>
          <select name="payment-mode" required>
            <option value="">Select Payment Mode</option>
            <option value="cash">Cash</option>
            <option value="check">Check</option>
            <option value="upi">UPI</option>
            <option value="bank-transfer">Bank Transfer</option>
          </select>
        </div>
        <div class="form-group">
          <button type="submit">Submit Payment</button>
          <button type="button" onclick="cancelToOrders()">Cancel</button>
        </div>
      </form>
    </section>

    <section id="payment-detail-section">
      <h2>MH Qadri Export Rugs</h2>
      <h3>Payment Details  <span id="payment-detail-name"></span></h3>
      <div id="order-summary">
        <h3>Order Summary</h3>
        <p>Received Order Amount: <span id="total-received-binai">0</span></p>
        <p>Balance Order Amount: <span id="total-balance-binai">0</span></p>
        <p>Order Deliver Binai Amount: <span id="total-deliver-binai">0</span></p>
      </div>
      <div id="payment-summary">
        <h3>Payment Summary</h3>
        <p>Total Deliver Binai Amount: <span id="total-deliver-binai-payment">0</span></p>
        <p>Total Paid Amount: <span id="total-paid-amount">0</span></p>
        <p>Outstanding Amount: <span id="outstanding-amount">0</span></p>
      </div>
      <div id="payment-history">
        <h3>Payment History</h3>
        <table id="payment-history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Amount</th>
              <th>Payment Mode</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="btn-group">
        <button onclick="cancelToOrders()">Back</button>
        <button class="pdf-download-btn" onclick="downloadPaymentDetailPDF()">Download PDF</button>
      </div>
      <div class="address-details">
        Adress Chhota Mirzapur Mirzapur Uttar Pradesh pin code 231001 Mobile 998445058 Proprietor mohd Hasan ansari
      </div>
    </section>
  </main>
  
  <footer>
    <p>MH Qadri Export Rugs © 2023</p>
  </footer>
  
  <script>
    function formatNumber(x) {
      return Number.isInteger(x) ? x.toString() : x.toFixed(2);
    }

    function numberWithCommas(x, decimals) {
      var parts = x.toFixed(decimals).split(".");
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return parts.join(".");
    }
    
    function formatBinaiAmount(x) {
      if (Number.isInteger(x)) {
        return numberWithCommas(x, 0);
      } else {
        return numberWithCommas(x, 1);
      }
    }
    
    var companyProfiles = [];
    var contractorProfiles = [];
    var selectedCompanyProfile = null;
    var selectedContractorProfile = null;
    var currentOrderType = "";
    var companyOrders = {};
    var contractorOrders = {};
    var tempAdditionalColumnsCompany = [];
    var tempAdditionalColumnsContractor = [];
    var companyStock = {};
    var companyPayments = {};
    var contractorPayments = {};

    function parseSizeToInches(sizeStr) {
      var parts = sizeStr.split('.');
      var feet = parseInt(parts[0], 10);
      var inches = parts[1] ? parseInt(parts[1], 10) : 0;
      if (isNaN(feet) || isNaN(inches) || feet < 1 || feet > 100 || inches < 0 || inches > 11) {
        throw new Error("Invalid size format");
      }
      return (feet * 12) + inches;
    }
    
    document.addEventListener("DOMContentLoaded", function() {
      var cp = localStorage.getItem("companyProfiles");
      var ctp = localStorage.getItem("contractorProfiles");
      var co = localStorage.getItem("companyOrders");
      var cto = localStorage.getItem("contractorOrders");
      var cs = localStorage.getItem("companyStock");
      var cpym = localStorage.getItem("companyPayments");
      var ctpym = localStorage.getItem("contractorPayments");
      var contractorTitle = localStorage.getItem('contractorTitle') || 'MH Qadri Export Rugs';
      var contractorSubtitle = localStorage.getItem('contractorSubtitle') || 'Mirzapur';
      if (cp) companyProfiles = JSON.parse(cp);
      if (ctp) contractorProfiles = JSON.parse(ctp);
      if (co) companyOrders = JSON.parse(co);
      if (cto) contractorOrders = JSON.parse(cto);
      if (cs) companyStock = JSON.parse(cs);
      if (cpym) companyPayments = JSON.parse(cpym);
      if (ctpym) contractorPayments = JSON.parse(ctpym);
      document.getElementById('contractor-title').textContent = contractorTitle;
      document.getElementById('contractor-subtitle').textContent = contractorSubtitle;
      updateProfileButtons();
      hideAllSections();

      document.getElementById('contractor-title').ondblclick = function() { editTitle(this, 'title'); };
      document.getElementById('contractor-subtitle').ondblclick = function() { editTitle(this, 'subtitle'); };
    });
    
    function downloadPDF(type) {
      var container = (type === "company") ? 
        document.getElementById("company-orders-container") : 
        document.getElementById("contractor-orders-container");
      
      var clone = container.cloneNode(true);
      var btnGroup = clone.querySelector('.btn-group');
      if (btnGroup) btnGroup.remove();
      
      var opt = {
        margin: 0.5,
        filename: type + "_orders.pdf",
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(clone).save();
    }

    function downloadPaymentDetailPDF() {
      var container = document.getElementById("payment-detail-section");
      var clone = container.cloneNode(true);
      var btnGroup = clone.querySelector('.btn-group');
      if (btnGroup) btnGroup.remove();
      var opt = {
        margin: 0.5,
        filename: "payment_details.pdf",
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(clone).save();
    }
    
    function hideAllSections() {
      document.getElementById('company-profile-section').style.display = 'none';
      document.getElementById('contractor-profile-section').style.display = 'none';
      document.getElementById('order-entry-section').style.display = 'none';
      document.getElementById('order-output-section').style.display = 'none';
      document.getElementById('pay-amount-section').style.display = 'none';
      document.getElementById('payment-detail-section').style.display = 'none';
    }
    
    function showCompanyProfileSection() {
      hideAllSections();
      document.getElementById('company-profile-section').style.display = 'block';
      tempAdditionalColumnsCompany = [];
    }
    
    function showContractorProfileSection() {
      hideAllSections();
      document.getElementById('contractor-profile-section').style.display = 'block';
      tempAdditionalColumnsContractor = [];
    }
    
    function showAddOrderSection(orderType, isReturn = false) {
      hideAllSections();
      currentOrderType = orderType;
      document.getElementById('order-entry-section').style.display = 'block';
      document.getElementById('current-order-type-label').textContent = (orderType === "company") ? "Company" : (isReturn ? "Carpet Bajar" : "Contractor");
      
      if (isReturn) {
        document.getElementById('company-select-label').textContent = "Select Company";
        document.getElementById('date-label').textContent = "Date*";
        document.getElementById('size-label').textContent = "Carpet Size (e.g., 9×12)";
        document.getElementById('peace-label').textContent = "Peace";
        document.getElementById('kati-label').textContent = "Carpet Weight";
        document.getElementById('rate-label').textContent = "Rate";
        document.getElementById('tana-group').style.display = 'none';
        document.getElementById('receive-amount-group').style.display = 'none';
      } else {
        document.getElementById('company-select-label').textContent = "Select Company";
        document.getElementById('date-label').textContent = "Date*";
        document.getElementById('size-label').textContent = "Size (e.g., 9×12)";
        document.getElementById('peace-label').textContent = "Peace";
        document.getElementById('kati-label').textContent = "Kati";
        document.getElementById('tana-label').textContent = "Tana";
        document.getElementById('rate-label').textContent = "Rate";
        document.getElementById('tana-group').style.display = 'block';
        document.getElementById('receive-amount-group').style.display = 'none';
      }
      
      loadCompanySelect();
      loadAdditionalFields();
      document.getElementById('is-return-input').value = isReturn ? 'true' : 'false';
    }
    
    function showCompanyOrders() {
      hideAllSections();
      document.getElementById('order-output-section').style.display = 'block';
      document.getElementById('company-orders-container').style.display = 'block';
      document.getElementById('contractor-orders-container').style.display = 'none';
      updateProfileDisplay();
      updateCompanyOrdersTable();
      updateCompanyStock();
    }
    
    function showContractorOrders() {
      hideAllSections();
      document.getElementById('order-output-section').style.display = 'block';
      document.getElementById('contractor-orders-container').style.display = 'block';
      document.getElementById('company-orders-container').style.display = 'none';
      updateProfileDisplay();
      updateContractorOrdersTable();
      updateContractorStock();
    }
    
    function cancelToOrders() {
      hideAllSections();
      if (currentOrderType === "company") {
        showCompanyOrders();
      } else if (currentOrderType === "contractor") {
        showContractorOrders();
      }
    }
    
    function loadCompanySelect() {
      var selectGroup = document.getElementById('company-select-group');
      var select = selectGroup.querySelector('select');
      select.innerHTML = "";
      if (currentOrderType === "contractor") {
        selectGroup.style.display = 'block';
        companyProfiles.forEach(function(profile) {
          var option = document.createElement("option");
          option.value = profile.name;
          option.textContent = profile.name;
          select.appendChild(option);
        });
      } else {
        selectGroup.style.display = 'none';
      }
    }
    
    function saveCompanyProfile() {
      var name = document.getElementById('company-name-input').value;
      var mobile = document.getElementById('company-mobile-input').value;
      var address = document.getElementById('company-address-input').value;
      if (!name || !mobile || !address) {
        alert("Please fill all company profile fields.");
        return;
      }
      var profile = { 
        name: name, 
        mobile: mobile, 
        address: address, 
        additionalColumns: tempAdditionalColumnsCompany.slice()
      };
      companyProfiles.push(profile);
      companyOrders[name] = [];
      companyStock[name] = { 
        kati: 0, 
        tana: 0, 
        finalGaj: 0, 
        binaiAmount: 0, 
        issueKati: 0, 
        issueTana: 0, 
        issueFinalGaj: 0, 
        issueBinaiAmount: 0, 
        sizePeaceMap: {}, 
        issueSizePeaceMap: {} 
      };
      companyPayments[name] = [];
      localStorage.setItem("companyProfiles", JSON.stringify(companyProfiles));
      localStorage.setItem("companyOrders", JSON.stringify(companyOrders));
      localStorage.setItem("companyStock", JSON.stringify(companyStock));
      localStorage.setItem("companyPayments", JSON.stringify(companyPayments));
      tempAdditionalColumnsCompany = [];
      document.getElementById('company-profile-form').reset();
      updateProfileButtons();
      hideAllSections();
    }
    
    function saveContractorProfile() {
      var name = document.getElementById('contractor-name-input').value;
      var mobile = document.getElementById('contractor-mobile-input').value;
      var address = document.getElementById('contractor-address-input').value;
      if (!name || !mobile || !address) {
        alert("Please fill all contractor profile fields.");
        return;
      }
      var profile = { 
        name: name, 
        mobile: mobile, 
        address: address, 
        additionalColumns: tempAdditionalColumnsContractor.slice()
      };
      contractorProfiles.push(profile);
      contractorOrders[name] = [];
      contractorPayments[name] = [];
      localStorage.setItem("contractorProfiles", JSON.stringify(contractorProfiles));
      localStorage.setItem("contractorOrders", JSON.stringify(contractorOrders));
      localStorage.setItem("contractorPayments", JSON.stringify(contractorPayments));
      tempAdditionalColumnsContractor = [];
      document.getElementById('contractor-profile-form').reset();
      updateProfileButtons();
      hideAllSections();
    }
    
    function updateProfileButtons() {
      var compContainer = document.getElementById('company-profile-buttons');
      compContainer.innerHTML = "";
      companyProfiles.forEach(function(profile) {
        var btn = document.createElement("button");
        btn.className = "profile-btn";
        btn.textContent = profile.name;
        btn.ondblclick = function() {
          if (confirm("Delete profile " + profile.name + "?")) {
            deleteCompanyProfile(profile);
          }
        };
        btn.onclick = function() { 
          selectedCompanyProfile = profile;
          showCompanyOrders();
        };
        compContainer.appendChild(btn);
      });
      var contrContainer = document.getElementById('contractor-buttons-container');
      contrContainer.innerHTML = "";
      contractorProfiles.forEach(function(profile) {
        var btn = document.createElement("button");
        btn.className = "profile-btn";
        btn.textContent = profile.name;
        btn.ondblclick = function() {
          if (confirm("Delete profile " + profile.name + "?")) {
            deleteContractorProfile(profile);
          }
        };
        btn.onclick = function() { 
          selectedContractorProfile = profile;
          showContractorOrders();
        };
        contrContainer.appendChild(btn);
      });
    }
    
    function deleteCompanyProfile(profile) {
      companyProfiles = companyProfiles.filter(function(p) {
        return p.name !== profile.name;
      });
      delete companyOrders[profile.name];
      delete companyStock[profile.name];
      delete companyPayments[profile.name];
      localStorage.setItem("companyProfiles", JSON.stringify(companyProfiles));
      localStorage.setItem("companyOrders", JSON.stringify(companyOrders));
      localStorage.setItem("companyStock", JSON.stringify(companyStock));
      localStorage.setItem("companyPayments", JSON.stringify(companyPayments));
      if (selectedCompanyProfile && selectedCompanyProfile.name === profile.name) {
        selectedCompanyProfile = null;
      }
      updateProfileButtons();
      hideAllSections();
    }
    
    function deleteContractorProfile(profile) {
      contractorProfiles = contractorProfiles.filter(function(p) {
        return p.name !== profile.name;
      });
      delete contractorOrders[profile.name];
      delete contractorPayments[profile.name];
      localStorage.setItem("contractorProfiles", JSON.stringify(contractorProfiles));
      localStorage.setItem("contractorOrders", JSON.stringify(contractorOrders));
      localStorage.setItem("contractorPayments", JSON.stringify(contractorPayments));
      if (selectedContractorProfile && selectedContractorProfile.name === profile.name) {
        selectedContractorProfile = null;
      }
      updateProfileButtons();
      hideAllSections();
    }
    
    function updateProfileDisplay() {
      var compInfo = document.getElementById('company-profile-info');
      if (selectedCompanyProfile) {
        compInfo.innerHTML = `<span>Name: <span id="company-output-name">${selectedCompanyProfile.name}</span></span>
                              <span>Mobile: <span id="company-output-mobile">${selectedCompanyProfile.mobile}</span></span>
                              <span>Address: <span id="company-output-address">${selectedCompanyProfile.address}</span></span>`;
      } else {
        compInfo.innerHTML = `<span>Name: N/A</span>
                              <span>Mobile: N/A</span>
                              <span>Address: N/A</span>`;
      }
      var contrInfo = document.getElementById('contractor-profile-info');
      if (selectedContractorProfile) {
        contrInfo.innerHTML = `<span>Name: <span id="contractor-output-name">${selectedContractorProfile.name}</span></span>
                               <span>Mobile: <span id="contractor-output-mobile">${selectedContractorProfile.mobile}</span></span>
                               <span>Address: <span id="contractor-output-address">${selectedContractorProfile.address}</span></span>`;
      } else {
        contrInfo.innerHTML = `<span>Name: N/A</span>
                               <span>Mobile: N/A</span>
                               <span>Address: N/A</span>`;
      }
    }
    
    function loadAdditionalFields() {
      var container = document.getElementById("additional-fields");
      container.innerHTML = "";
      var currentCols;
      if (currentOrderType === "company" && selectedCompanyProfile) {
        currentCols = selectedCompanyProfile.additionalColumns || [];
      } else if (currentOrderType === "contractor" && selectedContractorProfile) {
        currentCols = selectedContractorProfile.additionalColumns || [];
      } else {
        currentCols = [];
      }
      currentCols.forEach(function(col) {
        var div = document.createElement("div");
        div.className = "form-group";
        var label = document.createElement("label");
        label.textContent = col;
        var input = document.createElement("input");
        input.type = "text";
        input.name = col;
        div.appendChild(label);
        div.appendChild(input);
        container.appendChild(div);
      });
    }
    
    document.getElementById('order-entry-form').addEventListener('submit', function(event) {
      event.preventDefault();
      var isReturn = document.getElementById('is-return-input').value === 'true';
      var companySelect = document.querySelector('select[name="company-select"]');
      var selectedCompany = companySelect ? companySelect.value : null;
      var date = document.querySelector('input[name="date"]').value;
      var sizeInput = document.querySelector('input[name="size"]').value;
      var peace = parseFloat(document.querySelector('input[name="peace"]').value) || 0;
      var kati = parseFloat(document.querySelector('input[name="kati"]').value) || 0;
      var tana = (currentOrderType === "contractor" && isReturn) ? 0 : (parseFloat(document.querySelector('input[name="tana"]').value) || 0);
      var rate = parseFloat(document.querySelector('input[name="rate"]').value) || 0;
      var receiveAmount = 0;
      
      if (isReturn) {
        peace = -peace;
        kati = -kati;
        tana = -tana;
      }
      
      var sizeParts = sizeInput.split(/[×x]/);
      if (sizeParts.length !== 2) {
        alert("Please enter a valid size in the format 'width×height'");
        return;
      }
      try {
        var widthInches = parseSizeToInches(sizeParts[0].trim());
        var heightInches = parseSizeToInches(sizeParts[1].trim());
      } catch (e) {
        alert("Invalid size format. Please use formats like '4.1' or '5' between 1 to 100 feet and 0 to 11 inches.");
        return;
      }
      var product = widthInches * heightInches;
      var gaj = product / 1296;
      var finalGaj = gaj * peace;
      var binaiAmount = Math.round(finalGaj * rate);
      
      var displayedSize = sizeParts[0].trim() + "×" + sizeParts[1].trim();
      
      var additionalData = {};
      var currentCols = (currentOrderType === "company") ? 
        (selectedCompanyProfile ? selectedCompanyProfile.additionalColumns || [] : []) : 
        (selectedContractorProfile ? selectedContractorProfile.additionalColumns || [] : []);
      currentCols.forEach(function(col) {
        var input = document.querySelector('input[name="'+col+'"]');
        additionalData[col] = input ? input.value : "";
      });
      
      if (currentOrderType === "contractor" && selectedCompany && !isReturn) {
        var stock = companyStock[selectedCompany];
        if (!stock || !stock.sizePeaceMap[displayedSize] || stock.sizePeaceMap[displayedSize] < peace) {
          alert("Not enough peace in stock for size " + displayedSize);
          return;
        }
        if (stock.kati < kati) {
          alert("Not enough kati in stock");
          return;
        }
        if (stock.tana < tana) {
          alert("Not enough tana in stock");
          return;
        }
        if (stock.finalGaj < finalGaj) {
          alert("Not enough final gaj in stock");
          return;
        }
        if (stock.binaiAmount < binaiAmount) {
          alert("Not enough binai amount in stock");
          return;
        }
      }
      
      var order = {
        id: Date.now(),
        date: date,
        size: displayedSize,
        peace: peace,
        gaj: gaj,
        finalGaj: finalGaj,
        kati: kati,
        tana: tana,
        rate: rate,
        binaiAmount: binaiAmount,
        receiveAmount: receiveAmount,
        additional: additionalData,
        company: selectedCompany,
        isReturn: isReturn
      };
      
      if (currentOrderType === "company") {
        if (!companyOrders[selectedCompanyProfile.name]) {
          companyOrders[selectedCompanyProfile.name] = [];
        }
        companyOrders[selectedCompanyProfile.name].push(order);
        if (!companyStock[selectedCompanyProfile.name].sizePeaceMap[order.size]) {
          companyStock[selectedCompanyProfile.name].sizePeaceMap[order.size] = 0;
        }
        companyStock[selectedCompanyProfile.name].sizePeaceMap[order.size] += peace;
        companyStock[selectedCompanyProfile.name].kati += kati;
        companyStock[selectedCompanyProfile.name].tana += tana;
        companyStock[selectedCompanyProfile.name].finalGaj += finalGaj;
        companyStock[selectedCompanyProfile.name].binaiAmount += binaiAmount;
        localStorage.setItem("companyOrders", JSON.stringify(companyOrders));
        localStorage.setItem("companyStock", JSON.stringify(companyStock));
        showCompanyOrders();
      } else {
        if (!contractorOrders[selectedContractorProfile.name]) {
          contractorOrders[selectedContractorProfile.name] = [];
        }
        contractorOrders[selectedContractorProfile.name].push(order);
        if (selectedCompany) {
          companyStock[selectedCompany].sizePeaceMap[order.size] -= peace;
          companyStock[selectedCompany].kati -= kati;
          companyStock[selectedCompany].tana -= tana;
          companyStock[selectedCompany].finalGaj -= finalGaj;
          companyStock[selectedCompany].binaiAmount -= binaiAmount;
          if (!companyStock[selectedCompany].issueSizePeaceMap[order.size]) {
            companyStock[selectedCompany].issueSizePeaceMap[order.size] = 0;
          }
          companyStock[selectedCompany].issueSizePeaceMap[order.size] += peace;
          companyStock[selectedCompany].issueKati += kati;
          companyStock[selectedCompany].issueTana += tana;
          companyStock[selectedCompany].issueFinalGaj += finalGaj;
          companyStock[selectedCompany].issueBinaiAmount += binaiAmount;
          localStorage.setItem("companyStock", JSON.stringify(companyStock));
        }
        localStorage.setItem("contractorOrders", JSON.stringify(contractorOrders));
        showContractorOrders();
      }
    });
    
    function updateCompanyStock() {
      if (!selectedCompanyProfile) return;
      var orders = companyOrders[selectedCompanyProfile.name] || [];
      
      var receivedSizePeaceMap = {};
      var deliverSizePeaceMap = {};
      var totalReceivedPeace = 0, totalReceivedMaterial = 0, totalReceivedFinalGaj = 0, totalReceivedBinaiAmount = 0;
      var totalDeliverPeace = 0, totalDeliverMaterial = 0, totalDeliverFinalGaj = 0, totalDeliverBinaiAmount = 0;
      
      orders.forEach(function(order) {
        if (!order.isReturn) {
          if (!receivedSizePeaceMap[order.size]) receivedSizePeaceMap[order.size] = 0;
          receivedSizePeaceMap[order.size] += order.peace;
          totalReceivedPeace += order.peace;
          totalReceivedMaterial += order.kati + order.tana;
          totalReceivedFinalGaj += order.finalGaj;
          totalReceivedBinaiAmount += order.binaiAmount;
        } else {
          if (!deliverSizePeaceMap[order.size]) deliverSizePeaceMap[order.size] = 0;
          deliverSizePeaceMap[order.size] += Math.abs(order.peace);
          totalDeliverPeace += Math.abs(order.peace);
          totalDeliverMaterial += Math.abs(order.kati) + Math.abs(order.tana);
          totalDeliverFinalGaj += Math.abs(order.finalGaj);
          totalDeliverBinaiAmount += Math.abs(order.binaiAmount);
        }
      });
      
      var totalPaidAmount = (companyPayments[selectedCompanyProfile.name] || []).reduce(function(sum, p) { return sum + p.amount; }, 0);
      var remainingBinai = Math.max(0, totalDeliverBinaiAmount - totalPaidAmount);
      
      var receivedList = document.getElementById('company-received-list');
      receivedList.innerHTML = "";
      for (var size in receivedSizePeaceMap) {
        if (receivedSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(receivedSizePeaceMap[size])}</td>`;
          receivedList.appendChild(tr);
        }
      }
      document.getElementById('company-received-peace').textContent = formatNumber(totalReceivedPeace);
      document.getElementById('company-received-material').textContent = formatNumber(totalReceivedMaterial);
      document.getElementById('company-received-finalgaj').textContent = formatNumber(totalReceivedFinalGaj);
      document.getElementById('company-received-binai').textContent = formatBinaiAmount(totalReceivedBinaiAmount);
      
      var deliverList = document.getElementById('company-deliver-list');
      deliverList.innerHTML = "";
      for (var size in deliverSizePeaceMap) {
        if (deliverSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(deliverSizePeaceMap[size])}</td>`;
          deliverList.appendChild(tr);
        }
      }
      document.getElementById('company-deliver-peace').textContent = formatNumber(totalDeliverPeace);
      document.getElementById('company-deliver-material').textContent = formatNumber(totalDeliverMaterial);
      document.getElementById('company-deliver-finalgaj').textContent = formatNumber(totalDeliverFinalGaj);
      document.getElementById('company-deliver-binai').textContent = formatBinaiAmount(remainingBinai);
      
      var balanceList = document.getElementById('company-balance-list');
      balanceList.innerHTML = "";
      var balanceSizePeaceMap = {};
      for (var size in receivedSizePeaceMap) {
        balanceSizePeaceMap[size] = (receivedSizePeaceMap[size] || 0) - (deliverSizePeaceMap[size] || 0);
        if (balanceSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(balanceSizePeaceMap[size])}</td>`;
          balanceList.appendChild(tr);
        }
      }
      var totalBalancePeace = totalReceivedPeace - totalDeliverPeace;
      var totalBalanceMaterial = totalReceivedMaterial - totalDeliverMaterial;
      var totalBalanceFinalGaj = totalReceivedFinalGaj - totalDeliverFinalGaj;
      var totalBalanceBinaiAmount = totalReceivedBinaiAmount - totalDeliverBinaiAmount;
      document.getElementById('company-balance-peace').textContent = formatNumber(totalBalancePeace);
      document.getElementById('company-balance-material').textContent = formatNumber(totalBalanceMaterial);
      document.getElementById('company-balance-finalgaj').textContent = formatNumber(totalBalanceFinalGaj);
      document.getElementById('company-balance-binai').textContent = formatBinaiAmount(totalBalanceBinaiAmount);
    }
    
    function updateContractorStock() {
      if (!selectedContractorProfile) return;
      var orders = contractorOrders[selectedContractorProfile.name] || [];
      
      var receivedSizePeaceMap = {};
      var deliverSizePeaceMap = {};
      var totalReceivedPeace = 0, totalReceivedMaterial = 0, totalReceivedFinalGaj = 0, totalReceivedBinaiAmount = 0;
      var totalDeliverPeace = 0, totalDeliverMaterial = 0, totalDeliverFinalGaj = 0, totalDeliverBinaiAmount = 0;
      
      orders.forEach(function(order) {
        if (!order.isReturn) {
          if (!receivedSizePeaceMap[order.size]) receivedSizePeaceMap[order.size] = 0;
          receivedSizePeaceMap[order.size] += order.peace;
          totalReceivedPeace += order.peace;
          totalReceivedMaterial += order.kati + order.tana;
          totalReceivedFinalGaj += order.finalGaj;
          totalReceivedBinaiAmount += order.binaiAmount;
        } else {
          if (!deliverSizePeaceMap[order.size]) deliverSizePeaceMap[order.size] = 0;
          deliverSizePeaceMap[order.size] += Math.abs(order.peace);
          totalDeliverPeace += Math.abs(order.peace);
          totalDeliverMaterial += Math.abs(order.kati) + Math.abs(order.tana);
          totalDeliverFinalGaj += Math.abs(order.finalGaj);
          totalDeliverBinaiAmount += Math.abs(order.binaiAmount);
        }
      });
      
      var totalPaidAmount = (contractorPayments[selectedContractorProfile.name] || []).reduce(function(sum, p) { return sum + p.amount; }, 0);
      var remainingBinai = Math.max(0, totalDeliverBinaiAmount - totalPaidAmount);
      
      var receivedList = document.getElementById('contractor-received-list');
      receivedList.innerHTML = "";
      for (var size in receivedSizePeaceMap) {
        if (receivedSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(receivedSizePeaceMap[size])}</td>`;
          receivedList.appendChild(tr);
        }
      }
      document.getElementById('contractor-received-peace').textContent = formatNumber(totalReceivedPeace);
      document.getElementById('contractor-received-material').textContent = formatNumber(totalReceivedMaterial);
      document.getElementById('contractor-received-finalgaj').textContent = formatNumber(totalReceivedFinalGaj);
      document.getElementById('contractor-received-binai').textContent = formatBinaiAmount(totalReceivedBinaiAmount);
      
      var deliverList = document.getElementById('contractor-deliver-list');
      deliverList.innerHTML = "";
      for (var size in deliverSizePeaceMap) {
        if (deliverSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(deliverSizePeaceMap[size])}</td>`;
          deliverList.appendChild(tr);
        }
      }
      document.getElementById('contractor-deliver-peace').textContent = formatNumber(totalDeliverPeace);
      document.getElementById('contractor-deliver-material').textContent = formatNumber(totalDeliverMaterial);
      document.getElementById('contractor-deliver-finalgaj').textContent = formatNumber(totalDeliverFinalGaj);
      document.getElementById('contractor-deliver-binai').textContent = formatBinaiAmount(remainingBinai);
      
      var balanceList = document.getElementById('contractor-balance-list');
      balanceList.innerHTML = "";
      var balanceSizePeaceMap = {};
      for (var size in receivedSizePeaceMap) {
        balanceSizePeaceMap[size] = (receivedSizePeaceMap[size] || 0) - (deliverSizePeaceMap[size] || 0);
        if (balanceSizePeaceMap[size] !== 0) {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${size}</td><td>${formatNumber(balanceSizePeaceMap[size])}</td>`;
          balanceList.appendChild(tr);
        }
      }
      var totalBalancePeace = totalReceivedPeace - totalDeliverPeace;
      var totalBalanceMaterial = totalReceivedMaterial - totalDeliverMaterial;
      var totalBalanceFinalGaj = totalReceivedFinalGaj - totalDeliverFinalGaj;
      var totalBalanceBinaiAmount = totalReceivedBinaiAmount - totalDeliverBinaiAmount;
      document.getElementById('contractor-balance-peace').textContent = formatNumber(totalBalancePeace);
      document.getElementById('contractor-balance-material').textContent = formatNumber(totalBalanceMaterial);
      document.getElementById('contractor-balance-finalgaj').textContent = formatNumber(totalBalanceFinalGaj);
      document.getElementById('contractor-balance-binai').textContent = formatBinaiAmount(totalBalanceBinaiAmount);
    }
    
    function updateCompanyOrdersTable() {
      var table = document.getElementById('company-order-table');
      var thead = table.getElementsByTagName('thead')[0];
      var tbody = table.getElementsByTagName('tbody')[0];
      thead.innerHTML = "";
      var headerRow = document.createElement("tr");
      var fixedCols = ["Date", "Size", "Gaj", "Peace", "Final Gaj", "Kati", "Tana", "Rate", "Binai Amount"];
      fixedCols.forEach(function(col) {
        var th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });
      var additionalCols = selectedCompanyProfile ? selectedCompanyProfile.additionalColumns || [] : [];
      additionalCols.forEach(function(col) {
        var th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      
      tbody.innerHTML = "";
      var orders = companyOrders[selectedCompanyProfile.name] || [];
      orders.forEach(function(order) {
        var row = tbody.insertRow();
        row.setAttribute("data-id", order.id);
        var peaceDisplay = formatNumber(order.peace);
        row.innerHTML = `
          <td>${order.date}</td>
          <td>${order.size}</td>
          <td>${formatNumber(order.gaj)}</td>
          <td>${peaceDisplay}</td>
          <td>${formatNumber(order.finalGaj)}</td>
          <td>${formatNumber(order.kati)}</td>
          <td>${formatNumber(order.tana)}</td>
          <td>${formatNumber(order.rate)}</td>
          <td>${formatBinaiAmount(order.binaiAmount)}</td>
        `;
        additionalCols.forEach(function(col) {
          var td = row.insertCell();
          td.textContent = order.additional && order.additional[col] ? order.additional[col] : "";
        });
        row.dataset.peace = order.peace;
        row.ondblclick = function() { editRow(this, "company"); };
      });
    }
    
    function updateContractorOrdersTable() {
      var table = document.getElementById('contractor-order-table');
      var thead = table.getElementsByTagName('thead')[0];
      var tbody = table.getElementsByTagName('tbody')[0];
      thead.innerHTML = "";
      var headerRow = document.createElement("tr");
      var fixedCols = ["Date", "Size", "Gaj", "Peace", "Final Gaj", "Kati", "Tana", "Rate", "Binai Amount", "Company"];
      fixedCols.forEach(function(col) {
        var th = document.createElement("th");
        th.textContent = col;
        if (col === "Company") th.classList.add("hidden");
        headerRow.appendChild(th);
      });
      var additionalCols = selectedContractorProfile ? selectedContractorProfile.additionalColumns || [] : [];
      additionalCols.forEach(function(col) {
        var th = document.createElement("th");
        th.textContent = col;
        headerRow.appendChild(th);
      });
      thead.appendChild(headerRow);
      
      tbody.innerHTML = "";
      var orders = contractorOrders[selectedContractorProfile.name] || [];
      orders.forEach(function(order) {
        var row = tbody.insertRow();
        row.setAttribute("data-id", order.id);
        var peaceDisplay = formatNumber(order.peace);
        row.innerHTML = `
          <td>${order.date}</td>
          <td>${order.size}</td>
          <td>${formatNumber(order.gaj)}</td>
          <td>${peaceDisplay}</td>
          <td>${formatNumber(order.finalGaj)}</td>
          <td>${formatNumber(order.kati)}</td>
          <td>${formatNumber(order.tana)}</td>
          <td>${formatNumber(order.rate)}</td>
          <td>${formatBinaiAmount(order.binaiAmount)}</td>
          <td class="hidden">${order.company || ''}</td>
        `;
        additionalCols.forEach(function(col) {
          var td = row.insertCell();
          td.textContent = order.additional && order.additional[col] ? order.additional[col] : "";
        });
        row.dataset.peace = order.peace;
        row.ondblclick = function() { editRow(this, "contractor"); };
      });
    }
    
    function editRow(row, type) {
      if (row.classList.contains('editing')) return;
      row.classList.add('editing');
      var cells = row.cells;
      var dateCell = cells[0];
      var dateVal = dateCell.textContent;
      dateCell.innerHTML = `<input type="date" value="${dateVal}">`;
      
      var sizeCell = cells[1];
      var sizeVal = sizeCell.textContent;
      sizeCell.innerHTML = `<input type="text" value="${sizeVal}">`;
      
      var peaceCell = cells[3];
      var peaceVal = row.dataset.peace ? row.dataset.peace : peaceCell.textContent;
      peaceCell.innerHTML = `<input type="number" step="any" value="${peaceVal}">`;
      
      var katiCell = cells[5];
      var katiVal = katiCell.textContent;
      katiCell.innerHTML = `<input type="number" step="any" value="${katiVal}">`;
      
      var tanaCell = cells[6];
      var tanaVal = tanaCell.textContent;
      tanaCell.innerHTML = `<input type="number" step="any" value="${tanaVal}">`;
      
      var rateCell = cells[7];
      var rateVal = rateCell.textContent;
      rateCell.innerHTML = `<input type="number" step="any" value="${rateVal}">`;
      
      var actionCell = cells[8];
      actionCell.innerHTML = `<button onclick="saveRow(this, '${type}')">Save</button> <button onclick="deleteRow(this, '${type}')">Delete</button>`;
      
      while (row.cells.length > 9) {
        row.deleteCell(9);
      }
      var orders = (type === "company") ? companyOrders[selectedCompanyProfile.name] : contractorOrders[selectedContractorProfile.name];
      var order = orders.find(o => o.id == row.getAttribute("data-id"));
      var currentCols = (type === "company") ? 
        (selectedCompanyProfile ? selectedCompanyProfile.additionalColumns || [] : []) : 
        (selectedContractorProfile ? selectedContractorProfile.additionalColumns || [] : []);
      currentCols.forEach(function(col) {
        var td = row.insertCell();
        var input = document.createElement("input");
        input.type = "text";
        input.value = order.additional && order.additional[col] ? order.additional[col] : "";
        td.appendChild(input);
      });
    }
    
    function saveRow(saveBtn, type) {
      var row = saveBtn.closest('tr');
      var cells = row.cells;
      var date = cells[0].querySelector('input').value;
      var sizeInput = cells[1].querySelector('input').value;
      var peace = parseFloat(cells[3].querySelector('input').value) || 0;
      row.dataset.peace = peace;
      var kati = parseFloat(cells[5].querySelector('input').value) || 0;
      var tana = parseFloat(cells[6].querySelector('input').value) || 0;
      var rate = parseFloat(cells[7].querySelector('input').value) || 0;
      
      var sizeParts = sizeInput.split(/[×x]/);
      if (sizeParts.length !== 2) {
        alert("Please enter a valid size in the format 'width×height'");
        return;
      }
      try {
        var widthInches = parseSizeToInches(sizeParts[0].trim());
        var heightInches = parseSizeToInches(sizeParts[1].trim());
      } catch (e) {
        alert("Invalid size format. Please use formats like '4.1' or '5' between 1 to 100 feet and 0 to 11 inches.");
        return;
      }
      var product = widthInches * heightInches;
      var gaj = product / 1296;
      var finalGaj = gaj * peace;
      var binaiAmount = Math.round(finalGaj * rate);
      
      var displayedSize = sizeParts[0].trim() + "×" + sizeParts[1].trim();
      
      var orderId = row.getAttribute("data-id");
      var orders = (type === "company") ? companyOrders[selectedCompanyProfile.name] : contractorOrders[selectedContractorProfile.name];
      var oldOrder = orders.find(o => o.id == orderId);
      var additionalData = {};
      var currentCols = (type === "company") ? 
        (selectedCompanyProfile ? selectedCompanyProfile.additionalColumns || [] : []) : 
        (selectedContractorProfile ? selectedContractorProfile.additionalColumns || [] : []);
      var additionalCells = Array.from(row.cells).slice(9);
      currentCols.forEach(function(col, index) {
        var input = additionalCells[index].querySelector("input");
        var val = input ? input.value : "";
        additionalData[col] = val;
        additionalCells[index].textContent = val;
      });

      if (type === "company") {
        companyStock[selectedCompanyProfile.name].sizePeaceMap[oldOrder.size] -= oldOrder.peace;
        if (companyStock[selectedCompanyProfile.name].sizePeaceMap[oldOrder.size] <= 0) {
          delete companyStock[selectedCompanyProfile.name].sizePeaceMap[oldOrder.size];
        }
        companyStock[selectedCompanyProfile.name].kati -= oldOrder.kati;
        companyStock[selectedCompanyProfile.name].tana -= oldOrder.tana;
        companyStock[selectedCompanyProfile.name].finalGaj -= oldOrder.finalGaj;
        companyStock[selectedCompanyProfile.name].binaiAmount -= oldOrder.binaiAmount;

        if (!companyStock[selectedCompanyProfile.name].sizePeaceMap[displayedSize]) {
          companyStock[selectedCompanyProfile.name].sizePeaceMap[displayedSize] = 0;
        }
        companyStock[selectedCompanyProfile.name].sizePeaceMap[displayedSize] += peace;
        companyStock[selectedCompanyProfile.name].kati += kati;
        companyStock[selectedCompanyProfile.name].tana += tana;
        companyStock[selectedCompanyProfile.name].finalGaj += finalGaj;
        companyStock[selectedCompanyProfile.name].binaiAmount += binaiAmount;

        var peaceDisplay = formatNumber(peace);
        cells[0].textContent = date;
        cells[1].textContent = displayedSize;
        cells[2].textContent = formatNumber(gaj);
        cells[3].textContent = peaceDisplay;
        cells[4].textContent = formatNumber(finalGaj);
        cells[5].textContent = formatNumber(kati);
        cells[6].textContent = formatNumber(tana);
        cells[7].textContent = formatNumber(rate);
        cells[8].textContent = formatBinaiAmount(binaiAmount);

        orders.forEach(function(o) {
          if (o.id == orderId) {
            o.date = date;
            o.size = displayedSize;
            o.gaj = gaj;
            o.peace = peace;
            o.finalGaj = finalGaj;
            o.kati = kati;
            o.tana = tana;
            o.rate = rate;
            o.binaiAmount = binaiAmount;
            o.additional = additionalData;
          }
        });
        localStorage.setItem("companyOrders", JSON.stringify(companyOrders));
        localStorage.setItem("companyStock", JSON.stringify(companyStock));
        updateCompanyStock();
      } else {
        if (oldOrder.company) {
          var company = oldOrder.company;
          companyStock[company].issueSizePeaceMap[oldOrder.size] -= oldOrder.peace;
          if (companyStock[company].issueSizePeaceMap[oldOrder.size] <= 0) {
            delete companyStock[company].issueSizePeaceMap[oldOrder.size];
          }
          companyStock[company].issueKati -= oldOrder.kati;
          companyStock[company].issueTana -= oldOrder.tana;
          companyStock[company].issueFinalGaj -= oldOrder.finalGaj;
          companyStock[company].issueBinaiAmount -= oldOrder.binaiAmount;

          if (!companyStock[company].sizePeaceMap[oldOrder.size]) {
            companyStock[company].sizePeaceMap[oldOrder.size] = 0;
          }
          companyStock[company].sizePeaceMap[oldOrder.size] += oldOrder.peace;
          companyStock[company].kati += oldOrder.kati;
          companyStock[company].tana += oldOrder.tana;
          companyStock[company].finalGaj += oldOrder.finalGaj;
          companyStock[company].binaiAmount += oldOrder.binaiAmount;
        }

        if (oldOrder.company) {
          var company = oldOrder.company;
          if (!companyStock[company].sizePeaceMap[displayedSize]) {
            companyStock[company].sizePeaceMap[displayedSize] = 0;
          }
          companyStock[company].sizePeaceMap[displayedSize] -= peace;
          companyStock[company].kati -= kati;
          companyStock[company].tana -= tana;
          companyStock[company].finalGaj -= finalGaj;
          companyStock[company].binaiAmount -= binaiAmount;

          if (!companyStock[company].issueSizePeaceMap[displayedSize]) {
            companyStock[company].issueSizePeaceMap[displayedSize] = 0;
          }
          companyStock[company].issueSizePeaceMap[displayedSize] += peace;
          companyStock[company].issueKati += kati;
          companyStock[company].issueTana += tana;
          companyStock[company].issueFinalGaj += finalGaj;
          companyStock[company].issueBinaiAmount += binaiAmount;
          localStorage.setItem("companyStock", JSON.stringify(companyStock));
        }

        var peaceDisplay = formatNumber(peace);
        cells[0].textContent = date;
        cells[1].textContent = displayedSize;
        cells[2].textContent = formatNumber(gaj);
        cells[3].textContent = peaceDisplay;
        cells[4].textContent = formatNumber(finalGaj);
        cells[5].textContent = formatNumber(kati);
        cells[6].textContent = formatNumber(tana);
        cells[7].textContent = formatNumber(rate);
        cells[8].textContent = formatBinaiAmount(binaiAmount);

        orders.forEach(function(o) {
          if (o.id == orderId) {
            o.date = date;
            o.size = displayedSize;
            o.gaj = gaj;
            o.peace = peace;
            o.finalGaj = finalGaj;
            o.kati = kati;
            o.tana = tana;
            o.rate = rate;
            o.binaiAmount = binaiAmount;
            o.additional = additionalData;
          }
        });
        localStorage.setItem("contractorOrders", JSON.stringify(contractorOrders));
        updateContractorStock();
      }
      
      row.classList.remove('editing');
      row.ondblclick = function() { editRow(this, type); };
      if (type === "company") {
        showCompanyOrders();
      } else {
        showContractorOrders();
      }
    }
    
    function deleteRow(deleteBtn, type) {
      if (!confirm("Are you sure you want to delete this order?")) return;
      var row = deleteBtn.closest('tr');
      var orderId = row.getAttribute("data-id");
      if (type === "company") {
        var orders = companyOrders[selectedCompanyProfile.name] || [];
        var orderToDelete = orders.find(o => o.id == orderId);
        if (orderToDelete) {
          if (companyStock[selectedCompanyProfile.name].sizePeaceMap[orderToDelete.size]) {
            companyStock[selectedCompanyProfile.name].sizePeaceMap[orderToDelete.size] -= orderToDelete.peace;
            if (companyStock[selectedCompanyProfile.name].sizePeaceMap[orderToDelete.size] <= 0) {
              delete companyStock[selectedCompanyProfile.name].sizePeaceMap[orderToDelete.size];
            }
          }
          companyStock[selectedCompanyProfile.name].kati = Math.max(0, companyStock[selectedCompanyProfile.name].kati - orderToDelete.kati);
          companyStock[selectedCompanyProfile.name].tana = Math.max(0, companyStock[selectedCompanyProfile.name].tana - orderToDelete.tana);
          companyStock[selectedCompanyProfile.name].finalGaj = Math.max(0, companyStock[selectedCompanyProfile.name].finalGaj - orderToDelete.finalGaj);
          companyStock[selectedCompanyProfile.name].binaiAmount = Math.max(0, companyStock[selectedCompanyProfile.name].binaiAmount - orderToDelete.binaiAmount);

          companyOrders[selectedCompanyProfile.name] = orders.filter(o => o.id != orderId);
          localStorage.setItem("companyOrders", JSON.stringify(companyOrders));
          localStorage.setItem("companyStock", JSON.stringify(companyStock));
          updateCompanyOrdersTable();
          updateCompanyStock();
        }
      } else {
        var orders = contractorOrders[selectedContractorProfile.name] || [];
        var orderToDelete = orders.find(o => o.id == orderId);
        if (orderToDelete) {
          if (orderToDelete.company) {
            var company = orderToDelete.company;
            if (companyStock[company].issueSizePeaceMap[orderToDelete.size]) {
              companyStock[company].issueSizePeaceMap[orderToDelete.size] -= orderToDelete.peace;
              if (companyStock[company].issueSizePeaceMap[orderToDelete.size] <= 0) {
                delete companyStock[company].issueSizePeaceMap[orderToDelete.size];
              }
            }
            companyStock[company].issueKati = Math.max(0, companyStock[company].issueKati - orderToDelete.kati);
            companyStock[company].issueTana = Math.max(0, companyStock[company].issueTana - orderToDelete.tana);
            companyStock[company].issueFinalGaj = Math.max(0, companyStock[company].issueFinalGaj - orderToDelete.finalGaj);
            companyStock[company].issueBinaiAmount = Math.max(0, companyStock[company].issueBinaiAmount - orderToDelete.binaiAmount);

            if (!companyStock[company].sizePeaceMap[orderToDelete.size]) {
              companyStock[company].sizePeaceMap[orderToDelete.size] = 0;
            }
            companyStock[company].sizePeaceMap[orderToDelete.size] += orderToDelete.peace;
            companyStock[company].kati += orderToDelete.kati;
            companyStock[company].tana += orderToDelete.tana;
            companyStock[company].finalGaj += orderToDelete.finalGaj;
            companyStock[company].binaiAmount += orderToDelete.binaiAmount;

            localStorage.setItem("companyStock", JSON.stringify(companyStock));
          }
          contractorOrders[selectedContractorProfile.name] = orders.filter(o => o.id != orderId);
          localStorage.setItem("contractorOrders", JSON.stringify(contractorOrders));
          updateContractorOrdersTable();
          updateContractorStock();
        }
      }
      if (type === "company") {
        showCompanyOrders();
      } else {
        showContractorOrders();
      }
    }
    
    document.getElementById('contractor-order-table').addEventListener('dblclick', function() {
      var hiddenCells = document.querySelectorAll('#contractor-order-table th.hidden, #contractor-order-table td.hidden');
      hiddenCells.forEach(function(cell) {
        cell.classList.remove('hidden');
      });
    });

    function showPayAmountSection(type) {
      hideAllSections();
      document.getElementById('pay-amount-section').style.display = 'block';
      var name = (type === "company") ? selectedCompanyProfile.name : selectedContractorProfile.name;
      document.getElementById('pay-to-name').textContent = name;
      currentOrderType = type;
      
      var orders = (type === "company") ? companyOrders[name] || [] : contractorOrders[name] || [];
      var totalDeliverBinai = 0;
      orders.forEach(function(order) {
        if (order.isReturn) {
          totalDeliverBinai += Math.abs(order.binaiAmount);
        }
      });
      var totalPaidAmount = (type === "company" ? companyPayments[name] || [] : contractorPayments[name] || []).reduce(function(sum, p) { return sum + p.amount; }, 0);
      var remainingBinai = Math.max(0, totalDeliverBinai - totalPaidAmount);
      document.getElementById('remaining-binai-display').value = formatBinaiAmount(remainingBinai);
    }

    document.getElementById('pay-amount-form').addEventListener('submit', function(event) {
      event.preventDefault();
      var date = document.querySelector('#pay-amount-form input[name="date"]').value;
      var amount = parseFloat(document.querySelector('#pay-amount-form input[name="amount"]').value) || 0;
      var paymentMode = document.querySelector('#pay-amount-form select[name="payment-mode"]').value;
      if (!date || amount <= 0 || !paymentMode) {
        alert("Please enter a valid date, amount, and select a payment mode.");
        return;
      }
      var payment = {
        id: Date.now(),
        date: date,
        amount: amount,
        mode: paymentMode
      };
      if (currentOrderType === "company") {
        if (!companyPayments[selectedCompanyProfile.name]) {
          companyPayments[selectedCompanyProfile.name] = [];
        }
        companyPayments[selectedCompanyProfile.name].push(payment);
        localStorage.setItem("companyPayments", JSON.stringify(companyPayments));
      } else {
        if (!contractorPayments[selectedContractorProfile.name]) {
          contractorPayments[selectedContractorProfile.name] = [];
        }
        contractorPayments[selectedContractorProfile.name].push(payment);
        localStorage.setItem("contractorPayments", JSON.stringify(contractorPayments));
      }
      document.getElementById('pay-amount-form').reset();
      if (currentOrderType === "company") {
        showCompanyOrders();
      } else {
        showContractorOrders();
      }
    });

    function showPaymentDetailSection(type) {
      hideAllSections();
      document.getElementById('payment-detail-section').style.display = 'block';
      var name = (type === "company") ? selectedCompanyProfile.name : selectedContractorProfile.name;
      document.getElementById('payment-detail-name').textContent = name;
      currentOrderType = type; // Ensure currentOrderType is set for cancelToOrders
      updatePaymentDetail(type, name);
    }

    function updatePaymentDetail(type, name) {
      var orders = (type === "company") ? companyOrders[name] || [] : contractorOrders[name] || [];
      var payments = (type === "company") ? companyPayments[name] || [] : contractorPayments[name] || [];
      
      var totalReceivedBinai = 0;
      var totalDeliverBinai = 0;
      var totalBalanceBinai = 0;
      
      orders.forEach(function(order) {
        if (!order.isReturn) {
          totalReceivedBinai += order.binaiAmount;
        } else {
          totalDeliverBinai += Math.abs(order.binaiAmount);
        }
      });
      totalBalanceBinai = totalReceivedBinai - totalDeliverBinai;
      
      var totalPaidAmount = payments.reduce(function(sum, payment) {
        return sum + payment.amount;
      }, 0);
      
      var outstandingAmount = totalDeliverBinai - totalPaidAmount;
      
      document.getElementById('total-received-binai').textContent = formatBinaiAmount(totalReceivedBinai);
      document.getElementById('total-deliver-binai').textContent = formatBinaiAmount(totalDeliverBinai);
      document.getElementById('total-balance-binai').textContent = formatBinaiAmount(totalBalanceBinai);
      document.getElementById('total-deliver-binai-payment').textContent = formatBinaiAmount(totalDeliverBinai);
      document.getElementById('total-paid-amount').textContent = formatBinaiAmount(totalPaidAmount);
      document.getElementById('outstanding-amount').textContent = formatBinaiAmount(outstandingAmount);
      
      var tbody = document.getElementById('payment-history-table').getElementsByTagName('tbody')[0];
      tbody.innerHTML = "";
      payments.forEach(function(payment) {
        var row = tbody.insertRow();
        row.setAttribute("data-id", payment.id);
        row.innerHTML = `<td>${payment.date}</td><td>${formatBinaiAmount(payment.amount)}</td><td>${payment.mode}</td>`;
        row.ondblclick = function() { editPaymentRow(this, type); };
      });
    }

    function editPaymentRow(row, type) {
      if (row.classList.contains('editing')) return;
      row.classList.add('editing');
      var cells = row.cells;
      var dateCell = cells[0];
      var dateVal = dateCell.textContent;
      dateCell.innerHTML = `<input type="date" value="${dateVal}">`;
      
      var amountCell = cells[1];
      var amountVal = amountCell.textContent.replace(/,/g, '');
      amountCell.innerHTML = `<input type="number" step="any" value="${amountVal}">`;
      
      var modeCell = cells[2];
      var modeVal = modeCell.textContent;
      modeCell.innerHTML = `<select><option value="cash" ${modeVal === 'cash' ? 'selected' : ''}>Cash</option><option value="check" ${modeVal === 'check' ? 'selected' : ''}>Check</option><option value="upi" ${modeVal === 'upi' ? 'selected' : ''}>UPI</option><option value="bank-transfer" ${modeVal === 'bank-transfer' ? 'selected' : ''}>Bank Transfer</option></select>`;
      
      var actionCell = row.insertCell();
      actionCell.innerHTML = `<button onclick="savePaymentRow(this, '${type}')">Save</button> <button onclick="deletePaymentRow(this, '${type}')">Delete</button>`;
    }

    function savePaymentRow(saveBtn, type) {
      var row = saveBtn.closest('tr');
      var cells = row.cells;
      var date = cells[0].querySelector('input').value;
      var amount = parseFloat(cells[1].querySelector('input').value) || 0;
      var mode = cells[2].querySelector('select').value;
      
      var paymentId = row.getAttribute("data-id");
      var payments = (type === "company") ? companyPayments[selectedCompanyProfile.name] : contractorPayments[selectedContractorProfile.name];
      payments.forEach(function(p) {
        if (p.id == paymentId) {
          p.date = date;
          p.amount = amount;
          p.mode = mode;
        }
      });
      if (type === "company") {
        localStorage.setItem("companyPayments", JSON.stringify(companyPayments));
      } else {
        localStorage.setItem("contractorPayments", JSON.stringify(contractorPayments));
      }
      
      cells[0].textContent = date;
      cells[1].textContent = formatBinaiAmount(amount);
      cells[2].textContent = mode;
      row.deleteCell(3);
      row.classList.remove('editing');
      row.ondblclick = function() { editPaymentRow(this, type); };
      updatePaymentDetail(type, (type === "company") ? selectedCompanyProfile.name : selectedContractorProfile.name);
      if (type === "company") updateCompanyStock();
      else updateContractorStock();
      if (type === "company") {
        showCompanyOrders();
      } else {
        showContractorOrders();
      }
    }

    function deletePaymentRow(deleteBtn, type) {
      if (!confirm("Are you sure you want to delete this payment?")) return;
      var row = deleteBtn.closest('tr');
      var paymentId = row.getAttribute("data-id");
      var payments = (type === "company") ? companyPayments[selectedCompanyProfile.name] : contractorPayments[selectedContractorProfile.name];
      payments = payments.filter(p => p.id != paymentId);
      if (type === "company") {
        companyPayments[selectedCompanyProfile.name] = payments;
        localStorage.setItem("companyPayments", JSON.stringify(companyPayments));
        updateCompanyStock();
      } else {
        contractorPayments[selectedContractorProfile.name] = payments;
        localStorage.setItem("contractorPayments", JSON.stringify(contractorPayments));
        updateContractorStock();
      }
      row.remove();
      updatePaymentDetail(type, (type === "company") ? selectedCompanyProfile.name : selectedContractorProfile.name);
      if (type === "company") {
        showCompanyOrders();
      } else {
        showContractorOrders();
      }
    }

    function editTitle(element, field) {
      if (element.classList.contains('editing')) return;
      element.classList.add('editing');
      var currentText = element.textContent;
      element.innerHTML = `<input type="text" value="${currentText}"> <button onclick="saveTitle(this, '${field}')">Save</button>`;
    }

    function saveTitle(saveBtn, field) {
      var container = saveBtn.parentElement;
      var input = container.querySelector('input');
      var newText = input.value;
      container.textContent = newText;
      container.classList.remove('editing');
      if (field === 'title') {
        localStorage.setItem('contractorTitle', newText);
      } else if (field === 'subtitle') {
        localStorage.setItem('contractorSubtitle', newText);
      }
      container.ondblclick = function() { editTitle(container, field); };
    }
  </script>
</body>
</html>